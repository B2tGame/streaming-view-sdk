import { assert } from 'chai';

import {createMockImport} from 'mock-import';

const {
  mockImport,
  reImport,
  stopAll,
} = createMockImport(import.meta.url);


// import * as StreamWebRtc from '../service/StreamWebRtc';


// This makes copies of the module to be tested, each copy can be generated with different mocks
const makeNetworkConnectivity = (mocks: any) => mockImport('./networkConnectivity', mocks);

// Mock for axios.get
const axiosGetMock = (urlToResponse: any) => (url: string, options: any) => new Promise((resolve) => window.setTimeout(() => resolve(urlToResponse(url)), 1));

// Mock for StreamWebRtc
// (we don't want to extend the original StreamWebRtc class, otherwise we risk unwittingly executing non-mocked methods)
const StreamWebRtcMock = {
  // calculateRoundTripTimeStats: StreamWebRtc.calculateRoundTripTimeStats,
  initRttMeasurement: ({ onConnected, onRttMeasure }: any) =>
    new Promise((resolve) => {
      window.setTimeout(onConnected, 10);
      window.setTimeout(() => onRttMeasure(230), 30);
      window.setTimeout(() => onRttMeasure(180), 100);
      window.setTimeout(() => resolve(() => {}), 1);
    }),
};

const mockEndpoint = 'mockEndpoint';

const mockRecommendedEdges = [
  {
    edgeRegion: 'pa-papuasia-1',
    measurementEndpoints: ['papuasia-host-1', 'papuasia-host-2', 'papuasia-host-3'],
  },
  {
    edgeRegion: 'mo-cornwall-0',
    measurementEndpoints: ['cornwall-host-1', 'cornwall-host-2'],
  },
];

describe('networkConnectivity', () => {
  describe('measure', () => {
    before(() => {});

    it('measure', async () => {
      const networkConnectivity = makeNetworkConnectivity({
        axios: { get: axiosGetMock((url: any) => ({ data: mockRecommendedEdges })) },
        '../service/StreamWebRtc': StreamWebRtcMock,
      });

      const expected = {
        predictedGameExperience: undefined,
        predictedGameExperienceStats: {
          alpha: {
            input: {
              packetLostPercent: 0,
              rtt: '[230,180]',
            },
            prediction: undefined,
          },
        },
        recommendedRegion: 'pa-papuasia-1',
        rttStatsByRegionByTurn: {
          'pa-papuasia-1': {
            0: {
              rtt: 205,
              stdDev: 25,
            },
            1: {
              rtt: 205,
              stdDev: 25,
            },
          },
          'mo-cornwall-0': {
            0: {
              rtt: 205,
              stdDev: 25,
            },
            1: {
              rtt: 205,
              stdDev: 25,
            },
          },
        },
      };

      // @ts-ignore
      const actual = await networkConnectivity.measure(mockEndpoint, mockRecommendedEdges);

      assert.deepStrictEqual(actual, expected);
    });
  });
});
